# 🎨 3D轨迹可视化更新说明

## 更新内容

### ✅ 1. 坐标系统对齐修复
- **问题**: 地面颜色区域与网格坐标错位
- **原因**: 像素坐标系统与世界坐标系统不匹配
- **解决**: 
  - 统一使用世界坐标系统 (0-50米)
  - 地图meshgrid使用 `np.linspace(0, 50, map_width)`
  - 轨迹直接使用世界坐标，不再除以分辨率
  - X/Y轴刻度直接标注世界坐标

### ✅ 2. 目标可视化 (亮绿色立方体)
- **显示**: 亮绿色(lime)3D立方体
- **位置**: 从 `simulated_map` 中提取高概率区域 (>0.7)
- **特点**:
  - 边框为深绿色
  - 高透明度 (alpha=0.95)
  - 与红色地图区域形成高对比度
  - 自动去重，避免密集区域过于拥挤
  - 最小间隔3米

### ✅ 3. 障碍物可视化 (黄色金字塔)
- **显示**: 黄色3D金字塔/三角锥
- **表示**: 空中障碍物 (树木、山峰等)
- **特点**:
  - 可配置高度 (默认10米)
  - 可配置底面大小 (默认3米)
  - 橙色边框
  - 半透明 (alpha=0.85)

### ✅ 4. 增强的轨迹显示
- **轨迹线**: 
  - 4种颜色区分不同智能体
  - 线宽4像素，清晰可见
  - zorder=100 确保在最上层
  
- **起始点标记**:
  - 球形标记 (marker='o')
  - 黑色边框突出显示
  - 大小100

- **图例**:
  - 左上角: 智能体标签
  - 右上角: 目标和障碍物说明

### ✅ 5. 改进的图表样式
- **图表尺寸**: 12x10 英寸 (更大更清晰)
- **视角**: elev=35°, azim=45° (最佳观察角度)
- **坐标轴标签**: X/Y Position (m), Altitude (m)
- **标题**: 显示当前训练步数
- **保存**: 使用 bbox_inches='tight' 避免裁剪

## 使用方法

### 在训练中自动生成
轨迹图会在训练过程中每20步自动生成，无需额外配置。

### 添加障碍物数据 (可选)
如果需要显示障碍物，修改 `coma_mission.py`:

```python
# 定义障碍物
obstacles = [
    {'x': 15, 'y': 35, 'z': 0, 'height': 12},
    {'x': 40, 'y': 15, 'z': 0, 'height': 15},
]

# 在调用plot_trajectories时传入
plot_trajectories(
    agent_positions,
    self.n_agents,
    self.writer,
    self.training_step_index,
    t_collision,
    self.budget,
    simulated_map,
    obstacles=obstacles  # 添加这个参数
)
```

## 文件位置

生成的轨迹图保存在两个位置:
- `marl_framework/log/plots/coma_pathes_3d_{步数}.png`
- `marl_framework/res/plots/coma_pathes_3d_{步数}.png`

## 可视化元素说明

| 元素 | 形状 | 颜色 | 含义 |
|------|------|------|------|
| 立方体 | 3D Cube | 红色 | 搜索目标 |
| 金字塔 | 3D Pyramid | 灰色 | 空中障碍物 |
| 轨迹线 | 线条 | 青/绿/品红/橙 | 智能体路径 |
| 球形 | 圆点 | 与轨迹同色 | 起始位置 |
| 地面 | 曲面 | 红蓝渐变 | 目标概率分布 |

## 效果预览

### 改进前:
- ❌ 网格与地图错位
- ❌ 没有目标标识
- ❌ 没有障碍物显示
- ❌ 轨迹单薄

### 改进后:
- ✅ 网格与地图完美对齐
- ✅ 红色立方体清晰标识目标
- ✅ 灰色金字塔标识障碍物位置和高度
- ✅ 粗轨迹线和起始点标记
- ✅ 专业的图例和标签
- ✅ 更大更清晰的图表

## 技术细节

### 坐标转换
```python
# 地图坐标 -> 世界坐标
world_x = np.linspace(0, 50, map_width)
world_y = np.linspace(0, 50, map_height)
Y, X = np.meshgrid(world_x, world_y)

# 目标像素坐标 -> 世界坐标
target_x = pixel_x * (50.0 / map_width)
target_y = pixel_y * (50.0 / map_height)
```

### 3D形状绘制
使用 `Poly3DCollection` 绘制自定义3D几何体:
- 立方体: 6个矩形面
- 金字塔: 4个三角形面 + 1个正方形底面

## 注意事项

1. **性能**: 目标密集时会自动去重，避免绘制过多立方体
2. **障碍物**: 默认为空，需要手动提供障碍物数据
3. **保存**: 图片以150 DPI保存，平衡文件大小和清晰度
4. **内存**: 使用 `plt.close(fig)` 及时释放内存

## 未来改进

- [ ] 支持动态障碍物
- [ ] 添加风场可视化
- [ ] 支持实时3D旋转动画
- [ ] 添加轨迹播放功能
- [ ] 支持导出为视频格式
